@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration
@{
    ViewData["Title"] = "DMN Rule Manager";
    var apiBaseUrl = Configuration.GetSection("TreAPISettings")["Address"];
    var accessToken = (string)ViewBag.AccessToken ?? "";
}

<input type="hidden" id="authToken" name="authToken" value="@accessToken" />
<meta name="auth-token" content="@accessToken" />
<meta name="api-base-url" content="@apiBaseUrl" />

<script>
    const TRE_API_BASE_URL = '@apiBaseUrl';

    // Store token in sessionStorage for JavaScript access
    @if (!string.IsNullOrEmpty(accessToken))
    {
            <text>
            if (sessionStorage) {
                sessionStorage.setItem('authToken', '@Html.Raw(accessToken)');
                console.log('[OK] Keycloak access token stored in sessionStorage');
            }
            </text>
    }
    else
    {
            <text>
            console.warn('[WARNING] No Keycloak access token found. DMN API calls may fail with 401 Unauthorized.');
            console.log('Token from hidden input:', document.getElementById('authToken').value);
            </text>
    }
</script>


<div class="container-lg p-4">
    @* <div class="d-flex align-items-center justify-content-between mb-4">
        <h1 class="fs-3 mb-0">DMN Rule Manager</h1>
        <a asp-action="Test" class="btn btn-outline-primary">
            <i class="fas fa-flask"></i> Test DMN
        </a>
    </div> *@

    <div class="card shadow-sm">
        <div class="card-body">
            <!-- Action Buttons -->
            <div class="mb-3 d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-primary" id="addRuleBtn">
                    <i class="fas fa-plus"></i> Add New Rule
                </button>
                <button type="button" class="btn btn-outline-secondary" id="refreshBtn">
                    <i class="fas fa-sync"></i> Refresh
                </button>
                <button type="button" class="btn btn-outline-secondary" id="validateBtn">
                    <i class="fas fa-check-circle"></i> Validate
                </button>
                <button type="button" class="btn btn-outline-danger" id="deployBtn">
                    <i class="fas fa-rocket"></i> Deploy
                </button>
            </div>

                    <!-- Alert Messages -->
                    <div id="alertContainer"></div>

                    <!-- Loading Spinner -->
                    <div id="loadingSpinner" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading DMN rules...</p>
                    </div>

            <!-- DMN Table Information -->
            <div id="dmnInfo" class="alert alert-light border mb-3" style="display: none;">
                <div class="row small">
                    <div class="col-md-4">
                        <strong class="text-dark">Decision ID:</strong> <span id="decisionId" class="text-muted"></span>
                    </div>
                    <div class="col-md-4">
                        <strong class="text-dark">Decision Name:</strong> <span id="decisionName" class="text-muted"></span>
                    </div>
                    <div class="col-md-4">
                        <strong class="text-dark">Hit Policy:</strong> <span id="hitPolicy" class="text-muted"></span>
                    </div>
                </div>
            </div>

            <!-- Rules Table -->
            <div class="table-responsive">
                <table id="rulesTable" class="table table-hover" style="width:100%; display: none;">
                    <thead class="bg-light">
                        <tr>
                            <th class="text-dark">#</th>
                            <th class="text-dark">Description</th>
                            <!-- Input columns will be added dynamically -->
                            <!-- Output columns will be added dynamically -->
                            <th class="text-dark">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rules will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Rule Modal -->
<div class="modal fade" id="ruleModal" tabindex="-1" aria-labelledby="ruleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ruleModalLabel">Add New Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="ruleForm">
                    <input type="hidden" id="ruleId" />
                    <input type="hidden" id="isEdit" value="false" />

                    <div class="mb-3">
                        <label for="ruleDescription" class="form-label">Description (Optional)</label>
                        <input type="text" class="form-control" id="ruleDescription" placeholder="Enter rule description">
                    </div>

                    <h6 class="mt-3 mb-2">Input Values</h6>
                    <div id="inputFieldsContainer">
                        <!-- Input fields will be added dynamically -->
                    </div>

                    <h6 class="mt-3 mb-2">Output Values</h6>
                    <div id="outputFieldsContainer">
                        <!-- Output fields will be added dynamically -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveRuleBtn">Save Rule</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this rule?</p>
                <p><strong>This action cannot be undone and will be immediately deployed to Zeebe.</strong></p>
                <input type="hidden" id="deleteRuleId" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Rule</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Pass API URL from server configuration to JavaScript
        const TRE_API_BASE_URL = '@apiBaseUrl';
    </script>
    <script src="~/js/dmn-manager.js"></script>
}
