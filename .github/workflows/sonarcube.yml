name: Scan

on:
  push:
    branches:
      - 'fix/sonar-qube'

env:
  DAREUI: dare-control-ui
  DAREAPI: dare-control-api
  TREUI: dare-control-treui
  TREAPI: dare-control-treapi
  TREAGENT: dare-control-agent
  

jobs:
  scan-code:
    name: Scan
    runs-on: [self-hosted, linux, x64]
    # runs-on: windows-latest
    steps:
      - name: clone repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis.

      - name: scan ${{ env.DAREUI }} project
        run: |
          docker run --rm \
          -v $(pwd):/source \
          alleeex/dotnet-sonar:23.06.4-r2 \
          bash -c \
              "cd /source/src/DARE-FrontEnd \
              && dotnet /sonar-scanner/SonarScanner.MSBuild.dll begin \
              /k:${{ env.DAREUI }} /name:${{ env.DAREUI }} \
              /d:sonar.host.url=${{ secrets.SONAR_HOST_URL }} \
              /d:sonar.login=${{ secrets.SONAR_TOKEN }} \
              && dotnet restore "DARE-FrontEnd.csproj" \
              && dotnet build "DARE-FrontEnd.csproj" -c Release \
              && dotnet /sonar-scanner/SonarScanner.MSBuild.dll end \
              /d:sonar.login=${{ secrets.SONAR_TOKEN }}"

      - name: Sleep for 30 seconds to give the SQ server a chance to catch up
        run: sleep 30s
        shell: bash

      - name: scan ${{ env.DAREAPI }} project
        run: |
          docker run --rm \
          -v $(pwd):/source \
          alleeex/dotnet-sonar:23.06.4-r2 \
          bash -c \
              "cd /source/src/DARE-API \
              && dotnet /sonar-scanner/SonarScanner.MSBuild.dll begin \
              /k:${{ env.DAREAPI }} /name:${{ env.DAREAPI }} \
              /d:sonar.host.url=${{ secrets.SONAR_HOST_URL }} \
              /d:sonar.login=${{ secrets.SONAR_TOKEN }} \
              && dotnet restore "DARE-API.csproj" \
              && dotnet build "DARE-API.csproj" -c Release \
              && dotnet /sonar-scanner/SonarScanner.MSBuild.dll end \
              /d:sonar.login=${{ secrets.SONAR_TOKEN }}"

      - name: Sleep for 30 seconds to give the SQ server a chance to catch up
        run: sleep 30s
        shell: bash

      - name: scan ${{ env.TREUI }} project
        run: |
          docker run --rm \
          -v $(pwd):/source \
          alleeex/dotnet-sonar:23.06.4-r2 \
          bash -c \
              "cd /source/src/TRE-UI \
              && dotnet /sonar-scanner/SonarScanner.MSBuild.dll begin \
              /k:${{ env.TREUI }} /name:${{ env.TREUI }} \
              /d:sonar.host.url=${{ secrets.SONAR_HOST_URL }} \
              /d:sonar.login=${{ secrets.SONAR_TOKEN }} \
              && dotnet restore "TRE-UI.csproj" \
              && dotnet build "TRE-UI.csproj" -c Release \
              && dotnet /sonar-scanner/SonarScanner.MSBuild.dll end \
              /d:sonar.login=${{ secrets.SONAR_TOKEN }}"

      - name: Sleep for 30 seconds to give the SQ server a chance to catch up
        run: sleep 30s
        shell: bash
      
      - name: scan ${{ env.TREAPI }} project
        run: |
          docker run --rm \
          -v $(pwd):/source \
          alleeex/dotnet-sonar:23.06.4-r2 \
          bash -c \
              "cd /source/src/TRE-API \
              && dotnet /sonar-scanner/SonarScanner.MSBuild.dll begin \
              /k:${{ env.TREAPI }} /name:${{ env.TREAPI }} \
              /d:sonar.host.url=${{ secrets.SONAR_HOST_URL }} \
              /d:sonar.login=${{ secrets.SONAR_TOKEN }} \
              && dotnet restore "TRE-API.csproj" \
              && dotnet build "TRE-API.csproj" -c Release \
              && dotnet /sonar-scanner/SonarScanner.MSBuild.dll end \
              /d:sonar.login=${{ secrets.SONAR_TOKEN }}"

      - name: Sleep for 30 seconds to give the SQ server a chance to catch up
        run: sleep 30s
        shell: bash

      - name: scan ${{ env.TREAGENT }} project
        run: |
          docker run --rm \
          -v $(pwd):/source \
          alleeex/dotnet-sonar:23.06.4-r2 \
          bash -c \
              "cd /source/src/TREAgent \
              && dotnet /sonar-scanner/SonarScanner.MSBuild.dll begin \
              /k:${{ env.TREAGENT }} /name:${{ env.TREAGENT }} \
              /d:sonar.host.url=${{ secrets.SONAR_HOST_URL }} \
              /d:sonar.login=${{ secrets.SONAR_TOKEN }} \
              && dotnet restore "TREAgent.csproj" \
              && dotnet build "TREAgent.csproj" -c Release \
              && dotnet /sonar-scanner/SonarScanner.MSBuild.dll end \
              /d:sonar.login=${{ secrets.SONAR_TOKEN }}"

      - name: Sleep for 30 seconds to give the SQ server a chance to catch up
        run: sleep 30s
        shell: bash
